<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mindfullness Chime</title>
  <script>
let config = { 
  chimes : [{
    interval : 5,
    interval_type : "standard",
    ding : { 
      type : "sound", 
      sound_key : "sound1"
    }
  }], 
  sounds : {
    sound1 : "sounds/chimes.ogg"
  }
}

let intervals = []

function nextMatchingSecond(interval){ // interval is in minutes
  var now = new Date();
  var minutes = now.getMinutes();
  var minutesToNextChime = minutes % interval;
  if(minutesToNextChime == 0){
    minutesToNextChime = interval;
  }
  var seconds = now.getSeconds();
  var nextMatchingSecond = minutesToNextChime * 60 - seconds;
  return nextMatchingSecond;
}

var blinkTab = function(message, times) {
  var counter = 0;
  times = times || 5;
  var oldTitle = document.title,                                                           /* save original title */
    timeoutId,
    blink = function() { 
      counter++;
      if(counter > 10) {
        clear();
      } 
      document.title = document.title == message ? ' ' : message; 
    },  /* function to BLINK browser tab */
    clear = function() {                                                                 /* function to set title back to original */
      clearInterval(timeoutId);
      document.title = oldTitle;
      window.onmousemove = null;
      timeoutId = null;
    };

  if (!timeoutId) {
    timeoutId = setInterval(blink, 1000);
  }
  window.onmousemove = clear;                                                            /* stop changing title on moving the mouse */
};

function playDing(ding){
  console.log("ding " + new Date())
  blinkTab("Breathe", 5);
  ding.audioElem.play();
}

function clearTimers(){
  intervals.forEach(function (interval){
    clearTimeout(interval.firstChime);
    clearInterval(interval.repeater);
  });
  intervals = []
}

function initChime(chime) { 
  var ding = chime.ding;
  if(ding.type == "sound"){
    var audioElem = document.createElement("audio");
    audioElem.src = config.sounds[ding.sound_key];
    chime.ding.audioElem = audioElem;
  }
}

function startTimers() { 
  clearTimers();
  config.chimes.forEach(function(chime){
    if(chime.interval_type == "standard") {
      var secondsToFirstChime = nextMatchingSecond(chime.interval);
      var text = "Every " + chime.interval + " minutes";
      initChime(chime);
      var firstChimeTimeout = setTimeout(function() { 
        playDing(chime.ding);
        var subsequentChimesInterval = setInterval(function() { 
            playDing(chime.ding);      
        }, chime.interval * 60 * 1000);
        intervals.push({ firstChime : firstChimeTimeout, repeater : subsequentChimesInterval });
      }, secondsToFirstChime * 1000);
    }
  });
}

startTimers();
  </script>
</head>
<body>
  div#breathe>div.breathe
</body>
</html>
